{% extends "layouts/base_rh.html" %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}" />
<div>
    <select id="obraSelector" onchange="cambiarObra()">
        {% for obra in obras %}
        <option value="{{ obra.id }}" {% if forloop.first %}selected{% endif %}>{{ obra.nombre }}</option>
        {% endfor %}
    </select>
</div>

<div id="dataContainer"></div>
<div id="chartContainer" style="width: 100%; height: 400px;">
    <canvas id="attendanceChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        cambiarObra();  // Automatically trigger the change when the page loads
    });

    var myChart = null;  // Declare this variable globally to keep track of the chart instance

    function cambiarObra() {
        var obraId = document.getElementById('obraSelector').value;
        if (!obraId || obraId === 'undefined') {
            console.error('Invalid obraId:', obraId);
            return;  // Stop the function if obraId is invalid
        }
        fetch(`/summary_week_data_RH?obra_id=${obraId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                displayData(data);
                // Fetch data for the chart after successfully displaying card data
                return fetch(`/attendance_by_week_project_RH?obra_id=${obraId}`);
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok for chart data');
                }
                return response.json();
            })
            .then(chartData => {
                drawChart(chartData);
            })
            .catch(error => console.error('Error:', error));
    }

    function displayData(data) {
        var container = document.getElementById('dataContainer');
        container.innerHTML = '';  // Clear previous data
        var card = `
            <div class="card">
                <div class="card-header">${data.obra}</div>
                <div class="card-body">
                    <p>Empleados activos: ${data.active_employees}</p>
                    <p>Total pagado esta semana: $${data.total_payment_for_week}</p>
                    <p>Asistencia de la semana: ${data.porcentaje}%</p>
                </div>
            </div>
        `;
        container.innerHTML = card;
    }

    function drawChart(chartData) {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    // Check if a chart instance exists
    if (myChart) {
        myChart.destroy();  // Destroy the existing chart instance if present
    }
    myChart = new Chart(ctx, {
        type: 'line',  // Change to line to create an area chart
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Asistencia por categor√≠a',
                data: chartData.data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1,
                fill: true  // Set fill to true for area effect
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true  // Enable stacking
                }
            }
        }
    });
}

</script>

{% endblock %}
