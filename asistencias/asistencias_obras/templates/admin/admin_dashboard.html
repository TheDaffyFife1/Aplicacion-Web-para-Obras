{% extends "layouts/base_admin.html" %} {% block content %}
<meta name="csrf-token" content="{{ csrf_token }}" />

<head>  
  <!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<!-- DataTables Bootstrap 5 CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.css">

  <style>
  .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* crea 2 columnas */
        grid-gap: 20px; /* espacio entre las columnas */
        padding: 20px;

    }
    .grid-item {
        background-color: #f7f7f7; /* color de fondo para cada elemento de la grilla */
        border: 1px solid #e7e7e7; /* borde para cada elemento de la grilla */
        padding: 20px; /* espacio interior para cada elemento de la grilla */
        border-radius: 5px; /* esquinas redondeadas para cada elemento de la grilla */

    } 

.grid-item canvas {
    width: 100% !important;
    height: 100% !important; /* Esto asumirá la altura del contenedor padre */
    min-height: 300px; /* Puedes ajustar esto según sea necesario */
    max-height: 400px; /* Puedes ajustar esto según sea necesario */
    min-width: 300px; /* Puedes ajustar esto según sea necesario */
    max-width: 400px; /* Puedes ajustar esto según sea necesario */
    margin: 0 auto; /* Centra el elemento */
    display: block; /* Evita el espacio adicional debajo del elemento */
    border-radius: 5px; /* esquinas redondeadas para cada elemento de la grilla */
    
}

    .canvas_especial {
        
        min-width: 600px;
        max-width: 100%;
        height: 500px; /* Puedes ajustar esto según sea necesario */
        margin: 0 auto; /* Centra el elemento */
        display: block; /* Evita el espacio adicional debajo del elemento */
        border-radius: 5px; /* esquinas redondeadas para cada elemento de la grilla */
                            
    }
    .navbar {
    background-color: #333;
    position: fixed; /* Set the navbar to fixed position */
    top: 0; /* Position the navbar at the top of the page */
    width: 100%; /* Full width */
}
   

    </style>

</head>

<div>
  <div class="d-flex align-items-center justify-content-between">
    <h1 class="text-3xl text-black pb-6">Dashboard</h1>
    <div class="btn-group" role="group" aria-label="Dashboard buttons">
      <button type="button" class="btn btn-secondary" data-value="weekly">Semanal</button>
      <button type="button" class="btn btn-secondary" data-value="monthly">Mensual</button>
      <div class="btn-group" role="group">
        <button id="conjunto" type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          Conjunto de Semanas
        </button>
        <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
          <li><button class="dropdown-item" data-value="3">2 Semanas</button></li>
          <li><button class="dropdown-item" data-value="4">3 Semanas</button></li>
        </ul>
      </div>
    </div>
  </div>
<div class="max-w-full px-6 py-6 mx-auto" id="summary-info"></div>

<div class="p-4 rounded-lg">
  <!-- Asistencias sección -->
  <div class="p-4 bg-white shadow-md rounded-lg">
    <p class="text-xl pb-3 flex items-center">
      <i class="fas fa-plus mr-3"></i> Asistencias
    </p>
    <div class="w-full flex justify-center">
      <canvas id="attendance-chart" class="canvas_especial"></canvas>
    </div>
  </div>
</div>



<div class="p-4 rounded-lg" >
  <!--progreso seccion-->
  <div class="p-4 bg-white shadow-md rounded-lg">
      <p class="text-xl pb-3 flex items-center">
          <i class="fas fa-plus mr-3"></i> Progreso de obras
      </p>
      <div class="w-full flex justify-center">
          <canvas id="transcurrido" class="canvas_especial" ></canvas>
      </div>
  </div>





<div class="w-full mt-12 bg-white rounded-lg">

<div class="p-4 bg-white shadow-md rounded-lg">  

<p class="text-xl pb-3 flex items-center">
  <i class="mr-3"></i> Pagos por Obra
</p>
<div class="w-full flex justify-center">
  <canvas id="pagos_obra" class="canvas_especial" ></canvas>
</div>
</div>


</div>

</div>

</div>



<div class="w-full mt-12 bg-white rounded-lg">

  <div class="p-4 bg-white shadow-md rounded-lg">  
  
  <p class="text-xl pb-3 flex items-center">
    <i class="mr-3"></i> Supervisores por Obra
  </p>
  <table id="tablaSupervisores" class="table table-striped">
    <thead class="bg-gray-800 text-white">
        <tr>
          <th class="w-1/3 text-left py-3 px-4 uppercase font-semibold text-sm text-center">Recursos Humanos</th>
          <th class="w-1/3 text-left py-3 px-4 uppercase font-semibold text-sm">Obra</th>
        </tr>
    </thead>
    <tbody>
        <!--Datos obtenidos con AJAX-->
    </tbody>
  </table>
  
  </div>
  
  
  </div>
  
<script
  src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
  defer
></script>
<!-- Font Awesome -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"
  integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs="
  crossorigin="anonymous"
></script>
<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ChartJS Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<!-- Bootstrap Bundle JS (incluye Popper) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>



<script>

$(document).ready(function() {
  $.ajax({  
    url: "/ajax/supervisores_obras",
    method: "GET",
    dataType: "json",
    success: function(respuesta) {
      
      data = respuesta.data;
      var tabla = $("#tablaSupervisores tbody");
      tabla.empty();
      

      data.forEach(function(supervisor) {
        var fila = '<tr>' +
          '<td>' + supervisor.nombre + '</td>' +
          '<td>' + supervisor.obra + '</td>' +
          '</tr>';
        tabla.append(fila);
      });

    },
    error: function(error) {
      console.error("Error en la solicitud AJAX: ", error);
    }
  });
});


$(document).ready(function(){
  $.ajax({
    url: "/ajax/tabla_pagos/",
    method: "GET",
    success: function (respuesta) {
      var labels = respuesta.labels; // Asume que la respuesta incluye etiquetas
      var data = respuesta.data; // Asume que la respuesta incluye los datos correspondientes

      var ctx = document.getElementById('pagos_obra').getContext('2d'); // Obtiene el contexto del canvas
      var myChart = new Chart(ctx, {
        type: 'line', // Tipo de gráfica
        data: {
          labels: labels, // Usar las etiquetas recibidas
          datasets: [{
            label: 'Pagos por obra', // Puedes cambiar este texto por algo más descriptivo según tus datos
            data: data, // Usar los datos recibidos
            backgroundColor: "rgba(255, 99, 132, 0.2)", // Color de fondo
            borderColor: "rgba(255, 99, 132, 1)", // Color de la línea
            borderWidth: 2,
            fill: false // No rellenar bajo la línea
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true // El eje Y comienza en 0
            }
          },
          responsive: true, // Hace que la gráfica sea responsive
          maintainAspectRatio: false // Mantiene la proporción del aspecto según el tamaño dado
        }
      });
    },
    error: function (error) {
      console.error("Error en la solicitud AJAX: ", error);
    }
  });
});



  $(document).ready(function () {
    $.ajax({
      url: "/ajax/progreso_obras/",
      method: "GET",
      success: function (respuesta) {
        labels = respuesta.labels
        data = respuesta.data

        crearGrafica(
          labels,
          data,
          "bar",
          "transcurrido",
          "Progreso de Obras",
          true

        );

      },
      
    });

  });




function crearGrafica(etiquetas, datos, type, nombre, text, esHorizontal = false) {
    const ctx = document.getElementById(nombre).getContext("2d");

    const backgroundColors = [
        "rgba(255, 99, 132, 0.2)",
        "rgba(54, 162, 235, 0.2)",
        "rgba(255, 206, 86, 0.2)",
        "rgba(75, 192, 192, 0.2)",
        "rgba(153, 102, 255, 0.2)",
        "rgba(255, 159, 64, 0.2)"
    ];

    const borderColors = [
        "rgba(255, 99, 132, 1)",
        "rgba(54, 162, 235, 1)",
        "rgba(255, 206, 86, 1)",
        "rgba(75, 192, 192, 1)",
        "rgba(153, 102, 255, 1)",
        "rgba(255, 159, 64, 1)"
    ];
    if (datos.length > backgroundColors.length) {
        while (backgroundColors.length < datos.length) {
            backgroundColors = [...backgroundColors, ...backgroundColors.slice(0, datos.length - backgroundColors.length)];
        }
    }

    if (datos.length > borderColors.length) {
        while (borderColors.length < datos.length) {
            borderColors = [...borderColors, ...borderColors.slice(0, datos.length - borderColors.length)];
        }
    }

    const datasets = datos.map((dato, index) => ({
        label: etiquetas[index],
        data: [dato],
        backgroundColor: backgroundColors[index],
        borderColor: borderColors[index],
        borderWidth: 1
    }));

    const miGrafica = new Chart(ctx, {
        type: type,
        data: {
            labels: [''], datasets: datasets
        },
        options: {
            indexAxis: esHorizontal ? 'y' : 'x', // Define el eje principal para barras horizontales o verticales
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    display: type !== 'line', // Oculta el eje Y para gráficas de línea
                },
                x: {
                    beginAtZero: true,
                    display: type !== 'line', // Oculta el eje X para gráficas de línea
                }
            }
        },
        plugins: {
            legend: {
                position: "top"
            },
            title : {
                display: true,
                text: text
            }
        } 
    });
}


  document.addEventListener("DOMContentLoaded", function () {
    const csrftoken = document.querySelector("[name=csrf-token]").content;

    fetchSummaryData(csrftoken);
    fetchAttendanceByProject(csrftoken);

    // Controlador para botones de tiempo
    document.querySelectorAll('.btn[data-value]').forEach(button => {
      button.addEventListener('click', function() {
        const timeRange = this.getAttribute('data-value');
        fetchSummaryData(csrftoken, timeRange);
      });
    });

    // Controlador para botones de conjunto
    document.querySelectorAll('.dropdown-item[data-value]').forEach(button => {
      button.addEventListener('click', function() {
        const conjunto = this.getAttribute('data-value');
        fetchSummaryData(csrftoken, null, conjunto);
      });
    });
  });

  function fetchSummaryData(csrftoken, timeRange, conjunto) {

    $.ajax({
      url: "/summary-data/",
      method: "GET",
      data: {
        'time_range': timeRange || 'weekly',
        'conjunto': conjunto
      },
      success: function (response) {
        
        data = response.data;
        const summaryContainer = document.getElementById("summary-info");
        summaryContainer.innerHTML = `
            <div class="w-full px-6 py-6 mx-auto">
              <!-- row 1 -->
              <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Obras Activas:</p>
                  <h5 class="mb-2 font-bold dark:text-white"> ${data.active_projects}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center ">
                  <i class="ni leading-none ni-money-coins text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card2 -->
       <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total Empleados</p>
                  <h5 class="mb-2 font-bold dark:text-white">${data.active_employees}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center ">
                  <i class="ni leading-none ni-world text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card3 -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Porcentaje Asistencia</p>
                  <h5 class="mb-2 font-bold dark:text-white"> ${data.porcentaje}%</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-red-600"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400">
                  <i class="ni leading-none ni-paper-diploma text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card4 -->
      <div class="w-full max-w-full px-3 sm:w-1/2 sm:flex-none xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total a Pagar</p>
                  <h5 class="mb-2 font-bold dark:text-white">$ ${data.total_payment_for_week}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500">
                  <i class="ni leading-none ni-cart text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>    
          
            `;
      },
      error: function (xhr, status, error) {
        console.error("Error en la solicitud AJAX: ", xhr, status, error);
      },
    });
        

    fetch("/summary-data/")
      .then((response) => response.json())
      .then((data) => {
        
      })
      .catch((error) => console.error("Error:", error));
  }



  function fetchAttendanceByProject(csrftoken) {
    fetch("/attendance-by-project/")
      .then((response) => response.json())
      .then((data) => {
        const labels = data.map((item) => item.nombre);
        const fullTimeData = data.map((item) => item.full_time);
        const partTimeData = data.map((item) => item.part_time);
        const notAttendedData = data.map((item) => item.not_attended);

        const ctx = document
          .getElementById("attendance-chart")
          .getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Jornada Completa",
                data: fullTimeData,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
              {
                label: "Jornada Incompleta",
                data: partTimeData,
                backgroundColor: "rgba(255, 206, 86, 0.2)",
                borderColor: "rgba(255, 206, 86, 1)",
                borderWidth: 1,
              },
              {
                label: "Sin Asistencia",
                data: notAttendedData,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      })
      .catch((error) => console.error("Error:", error));
  }

 

</script>
{% endblock %}
