{% extends "layouts/base_admin.html" %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">

<h1 class="text-3xl text-black pb-6">Dashboard</h1>
<div class="max-w-full px-6 py-6 mx-auto" id="summary-info"></div>
<div class="flex flex-wrap -mx-3">
  <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
    <p class="text-xl pb-3 flex items-center">
      <i class="fas fa-plus mr-3"></i> Empleados por Obra
    </p>
    <div class="p-6 bg-white shadow-md rounded-lg">
      <canvas id="attendance-chart" class="w-full h-auto"></canvas>
    </div>
  </div>
  <div class="w-full md:w-1/2 px-3">
    <p class="text-xl pb-3 flex items-center">
      <i class="fas fa-check mr-3"></i> Progreso de Obra
    </p>
    <div class="p-6 bg-white shadow-md rounded-lg">
      <canvas id="progress-chart" class="w-full h-auto"></canvas>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
                <!-- Font Awesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
                <!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = document.querySelector('[name=csrf-token]').content;

fetchSummaryData(csrftoken);
fetchAttendanceByProject(csrftoken);
fetchProjectProgress(csrftoken);

});

function fetchSummaryData(csrftoken) {
    fetch('/summary-data/')
        .then(response => response.json())
        .then(data => {
            const summaryContainer = document.getElementById('summary-info');
            summaryContainer.innerHTML = `
            <div class="w-full px-6 py-6 mx-auto">
              <!-- row 1 -->
              <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Obras Activas:</p>
                  <h5 class="mb-2 font-bold dark:text-white"> ${data.active_projects}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center ">
                  <i class="ni leading-none ni-money-coins text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card2 -->
       <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Empleados Laborando</p>
                  <h5 class="mb-2 font-bold dark:text-white">${data.active_employees}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center ">
                  <i class="ni leading-none ni-world text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card3 -->
      <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total a Pagar</p>
                  <h5 class="mb-2 font-bold dark:text-white">$ ${data.total_payment_for_today}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-red-600"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400">
                  <i class="ni leading-none ni-paper-diploma text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card4 -->
      <div class="w-full max-w-full px-3 sm:w-1/2 sm:flex-none xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-row -mx-3">
              <div class="flex-none w-2/3 max-w-full px-3">
                <div>
                  <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Empleado Activos</p>
                  <h5 class="mb-2 font-bold dark:text-white">${data.jornadas_completas}</h5>
                  <p class="mb-0 dark:text-white dark:opacity-60">
                    <span class="text-sm font-bold leading-normal text-emerald-500"></span>
                  </p>
                </div>
              </div>
              <div class="px-3 text-right basis-1/3">
                <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500">
                  <i class="ni leading-none ni-cart text-lg relative top-3.5 text-white"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>    
          
            `;
        })
        .catch(error => console.error('Error:', error));
}

function fetchAttendanceByProject(csrftoken) {
    fetch('/attendance-by-project/')
        .then(response => response.json())
        .then(data => {
            const labels = data.map(item => item.nombre);
            const fullTimeData = data.map(item => item.full_time);
            const partTimeData = data.map(item => item.part_time);
            const notAttendedData = data.map(item => item.not_attended);

            const ctx = document.getElementById('attendance-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Jornada Completa',
                            data: fullTimeData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Media Jornada',
                            data: partTimeData,
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'No Asistieron',
                            data: notAttendedData,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error:', error));
}

function fetchProjectProgress(csrftoken) {
    fetch('/project-progress/')
        .then(response => response.json())
        .then(data => {
            const labels = data.map(item => item.nombre);
            const progressData = data.map(item => item.progress);

            const ctx = document.getElementById('progress-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progreso de la Obra (%)',
                        data: progressData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuad'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },

                    }
                }
            });
        })
        .catch(error => console.error('Error:', error));
}

</script>
{% endblock %}