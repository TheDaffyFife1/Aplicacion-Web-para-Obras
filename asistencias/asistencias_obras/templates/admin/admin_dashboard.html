{% extends "layouts/base_admin.html" %} 
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}" />

<head>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
  <!-- DataTables Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<div class="container mt-5">
  <h1>Dashboard</h1>
  <div class="btn-group" role="group" aria-label="Time Range Buttons">
    <button type="button" class="btn btn-secondary" onclick="setTimeRange('weekly')">Semanal</button>
    <button type="button" class="btn btn-secondary" onclick="setTimeRange('monthly')">Mensual</button>
  </div>

  <div id="conjunto-group" class="btn-group" style="display:none;">
    <button id="conjunto-button" type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      Conjunto de Semanas
    </button>
    <ul class="dropdown-menu">
      <li><button class="dropdown-item" onclick="setConjunto(1)">1 Semana</button></li>
      <li><button class="dropdown-item" onclick="setConjunto(2)">2 Semanas</button></li>
      <li><button class="dropdown-item" onclick="setConjunto(3)">3 Semanas</button></li>
    </ul>
  </div>

  <div id="result" class="mt-3">
    <!-- Results will be displayed here -->
  </div>
  <div id="result2" class="mt-3">
    <canvas id="attendanceChart"></canvas> <!-- Canvas for Chart.js -->
  </div>
  <div id="result3" class="mt-3">
    <canvas id="progressChart"></canvas> <!-- Canvas for Chart.js progress chart -->

    <!-- Results will be displayed here -->
  </div>
</div>

<script>
  let timeRange = 'weekly';  // Default time range
  let conjunto = 1;          // Default to 1 week
  let attendanceChart = null; // Global variable to manage chart instance

  document.addEventListener('DOMContentLoaded', function() {
    setTimeRange('weekly');  // Set default to 'weekly'
  });

  function setTimeRange(value) {
    timeRange = value;
    document.getElementById('conjunto-group').style.display = (timeRange === 'weekly' ? 'block' : 'none');
    conjunto = (timeRange === 'weekly' ? conjunto : 1); // Reset conjunto to 1 for monthly
    tryFetchData();
  }

  function setConjunto(value) {
    conjunto = value;
    tryFetchData();
  }

  function tryFetchData() {
    fetchSummaryData();
    fetchAttendanceData();
    fetchProgressData();
  }

  function fetchSummaryData() {
    fetch(`/summary_week_data?time_range=${timeRange}&conjunto=${conjunto}`)
        .then(response => response.json())
        .then(data => {
            const summary = data.data;
            const cardsHtml = `
                <div class="flex flex-wrap justify-center">
                    <div class="max-w-sm rounded overflow-hidden shadow-lg bg-white m-4 p-4">
                        <h2 class="text-xl font-bold">Proyectos Activos</h2>
                        <p>${summary.active_projects}</p>
                    </div>
                    <div class="max-w-sm rounded overflow-hidden shadow-lg bg-white m-4 p-4">
                        <h2 class="text-xl font-bold">Empleados Activos</h2>
                        <p>${summary.active_employees}</p>
                    </div>
                    <div class="max-w-sm rounded overflow-hidden shadow-lg bg-white m-4 p-4">
                        <h2 class="text-xl font-bold">Total a Pagar</h2>
                        <p>$${summary.total_payment_for_week.toFixed(2)}</p>
                    </div>
                    <div class="max-w-sm rounded overflow-hidden shadow-lg bg-white m-4 p-4">
                        <h2 class="text-xl font-bold">Porcentaje de asistencia</h2>
                        <p>${summary.attendance_percentage}%</p>
                    </div>
                </div>
            `;
            document.getElementById('result').innerHTML = cardsHtml;
        })
        .catch(error => {
            console.error('Error fetching summary data:', error);
            document.getElementById('result').innerHTML = 'Error fetching summary data. Please try again.';
        });
}
function fetchAttendanceData() {
    fetch(`/attendance_by_week_project?time_range=${timeRange}&conjunto=${conjunto}`)
      .then(response => response.json())
      .then(data => {
        const labels = data.map(obra => obra.nombre);
        const fullTime = data.map(obra => obra.full_time);
        const partTime = data.map(obra => obra.part_time);
        const notAttended = data.map(obra => obra.not_attended);

        if (attendanceChart) {
          attendanceChart.destroy(); // Destroy the existing chart before creating a new one
        }

        const ctx = document.getElementById('attendanceChart').getContext('2d');
        attendanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Jornada Completa',
              data: fullTime,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }, {
              label: 'Media Jornada',
              data: partTime,
              backgroundColor: 'rgba(255, 206, 86, 0.2)',
              borderColor: 'rgba(255, 206, 86, 1)',
              borderWidth: 1
            }, {
              label: 'No asistio',
              data: notAttended,
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Error fetching attendance data:', error);
        document.getElementById('result2').innerHTML = 'Error fetching attendance data. Please try again.';
      });
  }
  function fetchProgressData() {
    fetch(`/progreso_obras?time_range=${timeRange}&conjunto=${conjunto}`)
        .then(response => response.json())
        .then(data => {
            if (!data || !data.labels || !data.data) { // Check if data and its expected properties exist
                throw new Error('Invalid data structure received');
            }
            const projectNames = data.labels;
            const progressPercentages = data.data;

            const progressCtx = document.getElementById('progressChart').getContext('2d');
            if (window.progressChart instanceof Chart) {
                window.progressChart.destroy(); // Destroy the existing chart before creating a new one
            }
            window.progressChart = new Chart(progressCtx, {
                type: 'bar',
                data: {
                    labels: projectNames,
                    datasets: [{
                        label: 'Progress Percentage',
                        data: progressPercentages,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%'; // Append a percentage sign
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching progress data:', error);
            document.getElementById('result3').innerHTML = `Error fetching progress data: ${error.message}`;
        });
}

</script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
